{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user of the AedesGuard AI application, tracking their activities and points. Authentication details are managed externally.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserProfile entity, linked to an external authentication system's user ID."
        },
        "displayName": {
          "type": "string",
          "description": "The public display name of the user."
        },
        "totalPoints": {
          "type": "number",
          "description": "The cumulative points earned by the user for participating in 'Search & Destroy' activities."
        },
        "email": {
          "type": "string",
          "description": "Optional email address of the user for communication.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "The role of the user within the application (e.g., 'Citizen', 'PHI')."
        }
      },
      "required": [
        "id",
        "displayName",
        "totalPoints",
        "role"
      ]
    },
    "SurveillanceSample": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SurveillanceSample",
      "type": "object",
      "description": "Stores details of a mosquito larvae surveillance sample, including classification results, location, and AI-generated advice.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the SurveillanceSample entity."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp when the surveillance sample data was collected or uploaded.",
          "format": "date-time"
        },
        "latitude": {
          "type": "number",
          "description": "Latitude coordinate of the surveillance sample's location."
        },
        "longitude": {
          "type": "number",
          "description": "Longitude coordinate of the surveillance sample's location."
        },
        "originalImageUrl": {
          "type": "string",
          "description": "URL of the original image uploaded by the user, stored in Firebase Storage.",
          "format": "uri"
        },
        "processedImageUrl": {
          "type": "string",
          "description": "URL of the resized and normalized image sent to the AI model for classification.",
          "format": "uri"
        },
        "speciesType": {
          "type": "string",
          "description": "Classification result of the mosquito larvae species (e.g., 'Aedes aegypti', 'Culex', 'No Larvae Detected')."
        },
        "confidenceScore": {
          "type": "number",
          "description": "The AI model's confidence score (0.0 to 1.0) for the species classification."
        },
        "habitatDescription": {
          "type": "string",
          "description": "AI-generated description and analysis of the breeding site's surroundings (e.g., 'stagnant water in a discarded tire')."
        },
        "riskLevel": {
          "type": "number",
          "description": "Calculated risk level (1-10) based on species, habitat, and location, indicating potential dengue transmission risk."
        },
        "isNeutralized": {
          "type": "boolean",
          "description": "Indicates whether this specific breeding site has been confirmed as neutralized/cleaned."
        },
        "reportEnglish": {
          "type": "string",
          "description": "AI-generated risk report and safety advice in English."
        },
        "reportSinhala": {
          "type": "string",
          "description": "AI-generated risk report and safety advice in Sinhala."
        },
        "reportTamil": {
          "type": "string",
          "description": "AI-generated risk report and safety advice in Tamil."
        },
        "uploaderId": {
          "type": "string",
          "description": "Reference to the UserProfile who uploaded this surveillance sample. (Relationship: UserProfile 1:N SurveillanceSample)"
        }
      },
      "required": [
        "id",
        "timestamp",
        "latitude",
        "longitude",
        "originalImageUrl",
        "speciesType",
        "confidenceScore",
        "habitatDescription",
        "riskLevel",
        "isNeutralized",
        "uploaderId"
      ]
    },
    "PHIAlert": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "PHIAlert",
      "type": "object",
      "description": "Represents an automated alert generated for Public Health Inspectors (PHIs) when a high-risk breeding site is detected.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the PHIAlert entity."
        },
        "surveillanceSampleId": {
          "type": "string",
          "description": "Reference to the SurveillanceSample that triggered this alert. (Relationship: SurveillanceSample 1:1 PHIAlert)"
        },
        "alertTimestamp": {
          "type": "string",
          "description": "Timestamp when the automated alert was generated.",
          "format": "date-time"
        },
        "riskLevel": {
          "type": "number",
          "description": "The risk level from the associated surveillance sample that triggered this alert."
        },
        "isResolved": {
          "type": "boolean",
          "description": "Indicates whether this alert has been reviewed and addressed by a Public Health Inspector (PHI)."
        },
        "assignedToUserId": {
          "type": "string",
          "description": "Optional reference to the UserProfile (PHI) to whom this alert is assigned for investigation. (Relationship: UserProfile 1:N PHIAlert)"
        },
        "messageEnglish": {
          "type": "string",
          "description": "Detailed alert message in English, generated for PHIs."
        },
        "messageSinhala": {
          "type": "string",
          "description": "Detailed alert message in Sinhala, generated for PHIs."
        },
        "messageTamil": {
          "type": "string",
          "description": "Detailed alert message in Tamil, generated for PHIs."
        }
      },
      "required": [
        "id",
        "surveillanceSampleId",
        "alertTimestamp",
        "riskLevel",
        "isResolved"
      ]
    },
    "NeutralizationVerification": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "NeutralizationVerification",
      "type": "object",
      "description": "Records the verification process of a breeding site being neutralized/cleaned, typically by a second photo submission.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the NeutralizationVerification entity."
        },
        "surveillanceSampleId": {
          "type": "string",
          "description": "Reference to the original SurveillanceSample that this verification pertains to. (Relationship: SurveillanceSample 1:1 NeutralizationVerification)"
        },
        "verificationImageUrl": {
          "type": "string",
          "description": "URL of the image uploaded to confirm the breeding site's neutralization (e.g., cleaned tire, overturned pot).",
          "format": "uri"
        },
        "verificationTimestamp": {
          "type": "string",
          "description": "Timestamp when the neutralization verification image was uploaded.",
          "format": "date-time"
        },
        "isVerifiedByAI": {
          "type": "boolean",
          "description": "Indicates whether the AI has confirmed the successful neutralization of the breeding site from the verification image."
        },
        "verifierId": {
          "type": "string",
          "description": "Reference to the UserProfile who submitted this neutralization verification. (Relationship: UserProfile 1:N NeutralizationVerification)"
        },
        "pointsAwarded": {
          "type": "number",
          "description": "Points awarded to the verifier for successfully confirming a neutralized breeding site."
        }
      },
      "required": [
        "id",
        "surveillanceSampleId",
        "verificationImageUrl",
        "verificationTimestamp",
        "isVerifiedByAI",
        "verifierId",
        "pointsAwarded"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/userProfiles/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores individual user profile data, accessible only by the owning user. The 'id' field is implicitly mapped to the Firebase Authentication UID. Includes denormalized 'role' field."
        }
      },
      {
        "path": "/roles_phi/{userId}",
        "definition": {
          "entityName": "PhiRole",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Grants Public Health Inspector (PHI) role. The existence of a document at this path for a specific userId signifies PHI status for robust DBAC. No specific schema is expected beyond a simple placeholder document.",
          "params": [
            {
              "name": "userId",
              "description": "The UID of the user who is assigned the PHI role."
            }
          ]
        }
      },
      {
        "path": "/surveillanceSamples/{sampleId}",
        "definition": {
          "entityName": "SurveillanceSample",
          "schema": {
            "$ref": "#/backend/entities/SurveillanceSample"
          },
          "description": "Central collection for all mosquito larvae surveillance samples. Includes denormalized 'uploaderId' for authorization independence, allowing efficient queries for user-specific data, global heatmap visualization, and PHI access. The 'id' field of the sample is explicitly matched to '{sampleId}'.",
          "params": [
            {
              "name": "sampleId",
              "description": "The unique identifier for the surveillance sample."
            }
          ]
        }
      },
      {
        "path": "/phiAlerts/{alertId}",
        "definition": {
          "entityName": "PHIAlert",
          "schema": {
            "$ref": "#/backend/entities/PHIAlert"
          },
          "description": "Stores automated alerts triggered by high-risk surveillance samples, intended for Public Health Inspectors (PHIs). Includes denormalized 'assignedToUserId' for PHI-specific access control and 'surveillanceSampleId' for direct linkage. The 'id' field of the alert is explicitly matched to '{alertId}'.",
          "params": [
            {
              "name": "alertId",
              "description": "The unique identifier for the PHI alert."
            }
          ]
        }
      },
      {
        "path": "/neutralizationVerifications/{verificationId}",
        "definition": {
          "entityName": "NeutralizationVerification",
          "schema": {
            "$ref": "#/backend/entities/NeutralizationVerification"
          },
          "description": "Records user submissions to verify the neutralization of a breeding site. Includes denormalized 'verifierId' for authorization independence and 'surveillanceSampleId' for direct linkage to the original sample. The 'id' field of the verification is explicitly matched to '{verificationId}'.",
          "params": [
            {
              "name": "verificationId",
              "description": "The unique identifier for the neutralization verification."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure prioritizes Authorization Independence and Structural Segregation to simplify security rules and ensure scalability.\n\n1.  \"userProfiles/{userId}\": This collection stores individual user profiles. Access is strictly path-based: `request.auth.uid` must match `{userId}`. This ensures private user data is isolated. Each document also contains the `role` field for general categorization, but critical authorization (e.g., PHI status) is handled by a dedicated role collection.\n2.  \"roles_phi/{userId}\": This collection implements Database Access Control (DBAC) for Public Health Inspectors (PHIs). The *existence* of a document at `/roles_phi/$(request.auth.uid)` grants PHI privileges. This adheres to the 'Existence over Content' principle, eliminating the need for `get()` calls on `UserProfile` documents to check roles, making authorization atomic and highly performant for rules.\n3.  \"surveillanceSamples/{sampleId}\": This is the core collection for all mosquito larvae surveillance samples. Each document explicitly includes an `uploaderId` field, which is a direct denormalization of the sample's owner. This design achieves **Authorization Independence** by allowing security rules to check `resource.data.uploaderId == request.auth.uid` without `get()` calls to parent collections or user profiles. This collection also supports the **QAPs (Query as a Proxy)** principle:\n    *   For the global heatmap, read access can be granted to all authenticated users for specific fields (`latitude`, `longitude`, `riskLevel`, `isNeutralized`), enabling efficient listing without filtering in rules.\n    *   Users can list *only their own* samples efficiently by querying `where('uploaderId', '==', request.auth.uid)`, which is a secure and performant pattern.\n    *   PHIs (identified via `roles_phi`) can list all samples for broader surveillance.\n4.  \"phiAlerts/{alertId}\": This collection stores automated alerts for PHIs. The `assignedToUserId` field is denormalized within each alert document, allowing PHIs to access alerts assigned to them directly. All PHIs can read this collection, adhering to **Structural Segregation** as all alerts have a similar security posture (PHI-only access). Rule checks will use the `roles_phi` collection for PHI verification.\n5.  \"neutralizationVerifications/{verificationId}\": This collection records submissions for confirming neutralized breeding sites. The `verifierId` is denormalized into each document, enabling **Authorization Independence** for users to view their own verification submissions. PHIs (via `roles_phi` check) also have read access for oversight. This collection is crucial for the \"Search & Destroy\" feature and points system, with updates handled via Cloud Functions.\n\nThis structure allows for robust and easily debuggable security rules, minimizing complex `get()` calls and ensuring that all `list` operations are securely queryable. The denormalization of ownership (`uploaderId`, `verifierId`) and role-based access (`roles_phi`) are key to achieving high security and scalability."
  }
}